# SysY 编译器设计文档

> 本文档是 BUAA 2024 秋季编译原理课程的大作业——SysY 编译器的设计文档，包含了编译器的总体设计、词法分析、语法分析、语义分析、代码生成、代码优化等方面的设计，随着项目的迭代设计不断更新。

## 参考编译器介绍

> 我选择了 PL/0 编译器的源码进行阅读分析，因为其语言简单而结构又较为完整，方便迅速理解编译器的基本原理，从而能对将要实现的 SysY 编译器的架构设计有所帮助。

### PL/0 简介

PL/0 作为 Pascal 语言的子集，语法和语义较为简单，包含以下特点：

- 仅支持无符号整数类型，不支持浮点数、字符（串）等复杂数据类型，且最多 14 位
- 标识符由数字和字母组成，以字母开头，最长 10 位
- 支持过程定义和调用，过程无参、最多嵌套三层
- 变量的作用域在编译时确定，常量作用域为全局
- 有 13 个保留字：
    - `if` / `then` （条件语句），`while` / `do` （循环语句），`begin` / `end` （复合语句）
    - `read` （读语句），`write` （写语句），`call` （过程调用），`odd` （判断是否为奇数）
    - `var` ，`const` ，`procedure` （变量，常量，过程声明）

### 整体结构

PL/0 编译器的源码可大致分为一下几个部分：

- 基本数据结构、常量和各种全局变量的定义
- 一些过程（函数）的定义和实现，包括错误信息的输出、token (symbol) 流的读取、中间代码的生成和相关的测试、对一个块 (block) 进行编译、中间代码的解释执行等
- 编译器主程序 (main block) ，读取源文件，并调用上述的编译过程

### 接口设计

该编译器有以下几个主要接口：

- `program pl0` ：编译器的入口点

- `procedure error`  ：输出错误信息并增加错误计数器，其中错误信息由一个固定前缀、标识错误位置的若干空格 (cc) 、错误类型组成

- `procedure getsym` ：编译器的词法分析器，从源文件中读取下一个符号 (sym) 。将源程序分成单独的行来处理，采用有穷自动机识别各种符号

- `procedure gen` ：根据输入参数生成一条包含操作码、层次、地址的指令，检查代码索引并将指令存储在代码数组中 (code)

- `procedure test` ：检查当前符号是否在指定的符号集中

- `procedure block` ：编译器的核心部分，将指定块的代码转换为中间代码。其中：

    > 该部分参考了 copilot 的解释

    1. 变量声明：
        - `dx` ：数据分配索引
        - `tx0` ：初始表索引
        - `cx0` ：初始代码索引
    2. 内部过程：
        - `enter` ：将符号插入符号表
        - `position` ：查找标识符在符号表中的位置
        - `constdeclaration` ：处理常量声明
        - `vardeclaration` ：处理变量声明
        - `listcode` ：列出生成的代码
        - `statement` ：处理语句
        - `expression` ：处理表达式
        - `term` ：处理项
        - `factor` ：处理因子
        - `condition` ：处理条件
    3. 主要逻辑：
        - 初始化数据分配索引和符号表索引
        - 生成跳转指令，从声明部分跳转到语句部分
        - 处理常量声明、变量声明和过程声明
        - 处理语句
        - 生成返回指令
        - 列出生成的代码

- `procedure interpret` ：解释器，通过实现一个简单的栈式虚拟机，来解释和执行生成的中间代码

### 文件组织

由于 PL/0 语言和编译器使用的 Pascal 语言的特性，编译器的各个功能部分都写在了一个文件中；不过相应的，其各个功能部分也较为分明，也可为之后课程编译器的编写提供不错的示例。

## 编译器总体设计

目前的想法暂且是将要完成的编译器的各个功能部分分开，在主程序中主要提供词法分析、语法分析、语义分析与中间代码生成、代码优化和目标代码生成这几个接口。

实现不同接口和其他辅助功能（比如错误信息的处理、枚举类的使用）的文件要做到分门别类，让各个模块尽量符合“高内聚，低耦合”的思想。

## 词法分析设计

## 语法分析设计

## 语义分析设计

## 代码生成设计

## 代码优化设计